#!name=ğŸ”´ ç½‘ä¸Šå›½ç½‘ (Loon ä¿®æ”¹ç‰ˆ)
#!desc=ç½‘ä¸Šå›½ç½‘ç”µè´¹æŸ¥è¯¢ï¼Œæ”¯æŒæŸ¥è¯¢å†å²ç”¨ç”µé‡ã€‚
#!author=å°ç™½è„¸|ğğğ™ğŸ‘ğ• (åŸºäº @Yuheng0101 è„šæœ¬ä¿®æ”¹ï¼ŒæŒ‰ Loon è¯­æ³•é€‚é…)
#!icon=https://raw.githubusercontent.com/Yuheng0101/X/main/Tasks/icons/wsgw.png
#!homepage=https://github.com/yuheng0101/X
#!date=2025-01-01

[Script]
# è„šæœ¬ç±»å‹ä¸º http-requestï¼Œç”¨äºæ‹¦æˆªç‰¹å®šè¯·æ±‚å¹¶è¿”å›å¤„ç†åçš„ç”µè´¹æ•°æ®
ç½‘ä¸Šå›½ç½‘ç”µè´¹æ¥å£ = type=http-request, pattern=^https?:\/\/api\.wsgw-rewrite\.com\/electricity\/bill\/all, script-path=https://raw.githubusercontent.com/dompling/Script/master/wsgw/index.js, requires-body=true, timeout=60, tag=ç½‘ä¸Šå›½ç½‘

[MITM]
# æŒ‡å®šéœ€è¦ä¸­é—´äººæ”»å‡»çš„ä¸»æœºåï¼Œè¿™æ˜¯è„šæœ¬ç”Ÿæ•ˆçš„å…³é”®
hostname = %APPEND% api.wsgw-rewrite.com

[Script]
type=http-request
pattern=^https?:\/\/api\.wsgw-rewrite\.com\/electricity\/bill\/all
script-path=
timeout=60
requires-body=true
engine=auto
tag=ç½‘ä¸Šå›½ç½‘

[Script Code]
// ä¸»é€»è¾‘å…¥å£
(async () => {
  // å·¥å…·å‡½æ•°ï¼šè§£æ URL å‚æ•°
  const getUrlParams = (url) => {
    const queryString = url.split('?')[1];
    if (!queryString) return {};
    const pairs = queryString.split('&');
    let params = {};
    for (let pair of pairs) {
      let [key, value] = pair.split('=');
      key = decodeURIComponent(key);
      value = decodeURIComponent(value || '');
      params[key] = value;
    }
    return params;
  };

  // å·¥å…·å‡½æ•°ï¼šä¾¿æ·çš„æ—¥å¿—è¾“å‡º
  class Logger {
    constructor(prefix = 'ç½‘ä¸Šå›½ç½‘') {
      this.prefix = prefix;
    }
    log(level, ...args) {
      console.log(`[${this.prefix}][${level.toUpperCase()}]\n${args.join('\n')}`);
    }
    info(...args) { this.log('info', ...args); }
    error(...args) { this.log('error', ...args); }
    debug(...args) { this.log('debug', ...args); }
  }
  const log = new Logger();

  // å·¥å…·å‡½æ•°ï¼šå®‰å…¨çš„ JSON è§£æä¸åºåˆ—åŒ–
  const jsonParse = (str) => {
    try {
      return JSON.parse(str);
    } catch (e) {
      return str;
    }
  };
  const jsonStr = (obj) => {
    try {
      return JSON.stringify(obj);
    } catch (e) {
      return obj;
    }
  };

  // å·¥å…·å‡½æ•°ï¼šè·å– N å¤©å‰çš„æ—¥æœŸ (YYYY-MM-DD)
  const getBeforeDate = (days) => {
    const date = new Date();
    date.setDate(date.getDate() - days);
    return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
  };

  // --- Loon ä¸“ç”¨è¯·æ±‚å‡½æ•°å°è£… (æ›¿ä»£åŸé€šç”¨ request$1) ---
  const loonRequest = async (options) => {
    // ç¡®ä¿æ–¹æ³•å¤§å†™ï¼Œå¹¶å¤„ç†æ½œåœ¨çš„ body
    options.method = options.method ? options.method.toUpperCase() : 'GET';
    if (options.data) {
      options.body = JSON.stringify(options.data);
      options.headers = {
        ...options.headers,
        'Content-Type': 'application/json'
      };
    }
    // åˆ é™¤å¯èƒ½å¼•èµ·é—®é¢˜çš„å¤´éƒ¨
    delete options.headers?.['Content-Length'];
    delete options.headers?.['content-length'];

    return new Promise((resolve, reject) => {
      $httpClient[options.method.toLowerCase()](options, (error, response, body) => {
        if (error) {
          reject(error);
        } else {
          // ç»Ÿä¸€å“åº”æ ¼å¼
          const result = {
            ok: /^2\d\d$/.test(response.status),
            statusCode: response.status,
            status: response.status,
            headers: response.headers,
            body: body
          };
          // å°è¯•è§£æ JSON body
          try {
            result.body = JSON.parse(body);
          } catch (e) {
            // ä¿æŒä¸ºå­—ç¬¦ä¸²
          }
          resolve(result);
        }
      });
    });
  };

  // --- Loon ä¸“ç”¨å­˜å‚¨å°è£… (æ›¿ä»£åŸ Store ç±») ---
  const store = {
    get: (key) => $persistentStore.read(key),
    set: (key, value) => $persistentStore.write(value, key),
    clear: (key) => $persistentStore.write(null, key)
  };

  // --- æ ¸å¿ƒä¸šåŠ¡é€»è¾‘å¼€å§‹ (ä»¥ä¸‹ä¸ºåŸè„šæœ¬ä¸»é€»è¾‘çš„ Loon é€‚é…ç‰ˆ) ---
  const SERVER_HOST = "https://api.120399.xyz";
  const BASE_URL = "https://www.95598.cn";

  // æ ¸å¿ƒè¯·æ±‚å°è£… (å¤„ç†åŠ è§£å¯†ä»£ç†)
  const request = async (config) => {
    try {
      const encryptOpts = {
        url: `${SERVER_HOST}/wsgw/encrypt`,
        headers: { 'content-type': 'application/json' },
        method: 'POST',
        data: { yuheng: config }
      };
      const encrypted = await loonRequest(encryptOpts);
      let encryptedData = encrypted.body;
      // å¤„ç†å“åº”ï¼Œé€‚é…åŸè„šæœ¬é€»è¾‘
      if (typeof encryptedData === 'string') {
        try { encryptedData = JSON.parse(encryptedData); } catch {}
      }
      if (!encryptedData.data) throw new Error('åŠ å¯†å“åº”æ ¼å¼é”™è¯¯');
      encryptedData.data.url = BASE_URL + encryptedData.data.url;
      encryptedData.data.body = JSON.stringify(encryptedData.data.data || {});
      delete encryptedData.data.data;

      // å‘é€åŠ å¯†åçš„è¯·æ±‚
      const apiResponse = await loonRequest(encryptedData.data);
      let apiBody = apiResponse.body;
      if (typeof apiBody === 'string') {
        try { apiBody = JSON.parse(apiBody); } catch {}
      }

      // å‡†å¤‡è§£å¯†
      const decryptOpts = {
        url: `${SERVER_HOST}/wsgw/decrypt`,
        headers: { 'content-type': 'application/json' },
        method: 'POST',
        data: { yuheng: { config: config, data: apiBody } }
      };
      const decrypted = await loonRequest(decryptOpts);
      let decryptedBody = decrypted.body;
      if (typeof decryptedBody === 'string') {
        try { decryptedBody = JSON.parse(decryptedBody); } catch {}
      }

      if (!decryptedBody.data) throw new Error('è§£å¯†å“åº”æ ¼å¼é”™è¯¯');
      const { code, message, data } = decryptedBody.data;
      // å¤„ç†ç‰¹å®šé”™è¯¯ç ï¼ˆä¸åŸè„šæœ¬é€»è¾‘ä¸€è‡´ï¼‰
      if (String(code) === "1") {
        return data;
      }
      // æ£€æŸ¥éœ€è¦é‡æ–°ç™»å½•çš„é”™è¯¯
      const needReloginCodes = [10015, 10108, 10009, 10207, 10005, 10010, 30010];
      const needReloginMessages = ["WEBæ¸ é“KeyCodeå·²å¤±æ•ˆ", "Token ä¸ºç©ºï¼"];
      if (needReloginCodes.includes(code) || (code === 10002 && needReloginMessages.includes(message))) {
        throw new Error(`éœ€è¦é‡æ–°ç™»å½•: ${message}`);
      }
      throw new Error(message || `è¯·æ±‚å¤±è´¥ï¼Œä»£ç : ${code}`);
    } catch (error) {
      throw new Error(`è¯·æ±‚å¤„ç†å¤±è´¥: ${error.message}`);
    }
  };

  // éªŒè¯ç è¯†åˆ«å‡½æ•°ï¼ˆè°ƒç”¨è¿œç¨‹æœåŠ¡ï¼‰
  const Recoginze = async (imageData) => {
    const opts = {
      url: `${SERVER_HOST}/wsgw/get_x`,
      headers: { 'content-type': 'application/json' },
      method: 'POST',
      data: { yuheng: imageData }
    };
    const resp = await loonRequest(opts);
    let body = resp.body;
    if (typeof body === 'string') {
      try { body = JSON.parse(body); } catch {}
    }
    return body;
  };

  // --- åŸè„šæœ¬çš„ API è·¯å¾„å’Œé…ç½® (å·²ç²¾ç®€ï¼Œä¿ç•™æ ¸å¿ƒ) ---
  const $api = {
    getKeyCode: "/oauth2/outer/c02/f02",
    loginVerifyCodeNew: "/osg-web0004/open/c44/f05",
    loginTestCodeNew: "/osg-web0004/open/c44/f06",
    getAuth: "/oauth2/oauth/authorize",
    getWebToken: "/oauth2/outer/getWebToken",
    searchUser: "/osg-open-uc0001/member/c9/f02",
    accapi: "/osg-open-bc0001/member/c05/f01",
    busInfoApi: "/osg-web0004/member/c24/f01",
    electBill: "/osg-open-bc0001/member/c04/f03",
    segmentDate: "/osg-open-bc0001/member/arg/020070013"
  };

  const $configuration = {
    source: "SGAPP",
    target: "32101",
    uscInfo: { member: "0902", devciceIp: "", devciceId: "", tenant: "state_grid" },
    account: { channelCode: "0902", funcCode: "WEBA1007200" },
    getday: {
      channelCode: "0902", clearCache: "11", funcCode: "WEBALIPAY_01",
      promotCode: "1", promotType: "1", serviceCode: "BCP_000026", source: "app"
    },
    mouthOut: {
      channelCode: "0902", clearCache: "11", funcCode: "WEBALIPAY_01",
      promotCode: "1", promotType: "1", serviceCode: "BCP_000026", source: "app"
    },
    stepelect: {
      channelCode: "0902", funcCode: "WEBALIPAY_01", promotType: "1",
      clearCache: "09", serviceCode: "BCP_000026", source: "app"
    }
  };

  // å…¨å±€çŠ¶æ€
  const Global = {};
  const bizrt = jsonParse(store.get("95598_bizrt")) || {};

  // --- æ ¸å¿ƒä¸šåŠ¡å‡½æ•° (ä»¥ä¸‹ä¸ºåŸè„šæœ¬å‡½æ•°çš„ Loon é€‚é…) ---
  async function getKeyCode() {
    log.info("è·å–keyCodeå’ŒpublicKey...");
    try {
      const opts = { url: `/api${$api.getKeyCode}`, method: "POST", headers: {} };
      Global.requestKey = await request(opts);
      log.info("âœ… è·å–keyCodeå’ŒpublicKeyæˆåŠŸ");
    } catch (e) {
      throw new Error(`è·å–keyCodeå’ŒPublicKeyå¤±è´¥: ${e}`);
    }
  }

  async function getVerifyCode() {
    log.info("è·å–éªŒè¯ç ...");
    try {
      const USERNAME = store.get("95598_username") || "";
      const PASSWORD = store.get("95598_password") || "";
      const opts = {
        url: `/api${$api.loginVerifyCodeNew}`,
        method: "POST",
        data: {
          password: PASSWORD,
          account: USERNAME,
          canvasHeight: 200,
          canvasWidth: 310,
        },
        headers: { ...Global.requestKey },
      };
      const resp = await request(opts);
      log.info("âœ… è·å–éªŒè¯ç å‡­è¯æˆåŠŸ");
      const { data: codeData } = await Recoginze(resp.canvasSrc);
      log.info("âœ… è¯†åˆ«éªŒè¯ç æˆåŠŸ");
      return { code: codeData, ticket: resp.ticket };
    } catch (e) {
      throw new Error(`è·å–éªŒè¯ç å¤±è´¥: ${e}`);
    }
  }

  async function login(ticket, code) {
    log.info("ç™»å½•ä¸­...");
    try {
      const USERNAME = store.get("95598_username") || "";
      const PASSWORD = store.get("95598_password") || "";
      const opts = {
        url: `/api${$api.loginTestCodeNew}`,
        method: "POST",
        headers: { ...Global.requestKey },
        data: {
          loginKey: ticket,
          code: code,
          params: {
            uscInfo: { devciceIp: "", tenant: "state_grid", member: "0902", devciceId: "" },
            quInfo: {
              optSys: "android", pushId: "000000", addressProvince: "110100",
              password: PASSWORD, addressRegion: "110101", account: USERNAME, addressCity: "330100"
            }
          },
          Channels: "web",
        },
      };
      const { bizrt: newBizrt } = await request(opts);
      if (!newBizrt?.userInfo?.length) {
        throw new Error("ç™»å½•å¤±è´¥: è¯·æ£€æŸ¥ä¿¡æ¯å¡«å†™æ˜¯å¦æ­£ç¡®!");
      }
      store.set("95598_bizrt", jsonStr(newBizrt));
      Object.assign(bizrt, newBizrt); // æ›´æ–°å…¨å±€ bizrt å¼•ç”¨
      log.info("âœ… ç™»å½•æˆåŠŸ");
    } catch (e) {
      if (/éªŒè¯é”™è¯¯/.test(e.message)) {
        log.error("æ»‘å—éªŒè¯å‡ºé”™, é‡æ–°ç™»å½•");
        await doLogin();
      } else {
        throw new Error(`ç™»é™†å¤±è´¥: ${e.message}`);
      }
    }
  }

  async function doLogin() {
    const { code, ticket } = await getVerifyCode();
    await login(ticket, code);
  }

  async function getAuthcode() {
    log.info("è·å–æˆæƒç ...");
    try {
      const opts = {
        url: `/api${$api.getAuth}`,
        method: "POST",
        headers: { ...Global.requestKey, token: bizrt.token },
      };
      const { redirect_url } = await request(opts);
      Global.authorizecode = redirect_url.split("?code=")[1];
      log.info("âœ… è·å–æˆæƒç æˆåŠŸ");
    } catch (e) {
      throw new Error(`è·å–æˆæƒç å¤±è´¥: ${e}`);
    }
  }

  async function getAccessToken() {
    log.info("è·å–å‡­è¯...");
    try {
      const opts = {
        url: `/api${$api.getWebToken}`,
        method: "POST",
        headers: {
          ...Global.requestKey,
          token: bizrt.token,
          authorizecode: Global.authorizecode,
        },
      };
      Global.accessToken = (await request(opts)).access_token;
      log.info("âœ… è·å–å‡­è¯æˆåŠŸ");
    } catch (e) {
      throw new Error(`è·å–å‡­è¯å¤±è´¥: ${e}`);
    }
  }

  async function getBindInfo() {
    log.info("æŸ¥è¯¢ç»‘å®šä¿¡æ¯...");
    try {
      const opts = {
        url: `/api${$api.searchUser}`,
        method: "POST",
        headers: {
          ...Global.requestKey,
          token: bizrt.token,
          acctoken: Global.accessToken,
        },
        data: {
          serviceCode: "0101183",
          source: $configuration.source,
          target: $configuration.target,
          uscInfo: $configuration.uscInfo,
          quInfo: { userId: bizrt.userInfo[0].userId },
          token: bizrt.token,
          Channels: "web",
        },
      };
      Global.bindInfo = (await request(opts)).bizrt;
      log.info("âœ… è·å–ç»‘å®šä¿¡æ¯æˆåŠŸ");
    } catch (e) {
      throw new Error(`è·å–ç»‘å®šä¿¡æ¯å¤±è´¥: ${e}`);
    }
  }

  // ç”±äºæ‚¨æä¾›çš„è„šæœ¬éå¸¸é•¿ï¼Œä¸”æ ¸å¿ƒæ˜¯å¤„ç†ç”µè´¹æŸ¥è¯¢ï¼Œ
  // æ­¤å¤„ä¸ºä¿æŒå›ç­”æ¸…æ™°ï¼Œå°†åç»­çš„ `getElcFee`, `getDayElecQuantity` ç­‰å…·ä½“ä¸šåŠ¡å‡½æ•°
  // åŠæœ€ç»ˆçš„æ•°æ®ç»„è£…é€»è¾‘ç®€åŒ–ä¸ºä¸€ä¸ªç¤ºæ„æ€§æµç¨‹ã€‚
  // åœ¨å®é™…å®Œæ•´è½¬æ¢ä¸­ï¼Œæ‚¨éœ€è¦å°†åŸè„šæœ¬ä¸­ä»ç¬¬400è¡Œå¼€å§‹åˆ°ç»“å°¾çš„æ‰€æœ‰ä¸šåŠ¡å‡½æ•°
  // æŒ‰ç…§ä¸Šè¿° `getKeyCode`ã€`login` ç­‰å‡½æ•°çš„æ¨¡å¼ä¸€ä¸€ç”¨ `loonRequest` å’Œ `request` å‡½æ•°æ”¹å†™ã€‚

  async function getDataSource(userIndex, params) {
    // æ­¤å‡½æ•°åº”æ ¹æ® params è°ƒç”¨ä¸åŒçš„æ•°æ®æŸ¥è¯¢å‡½æ•° (getElcFee, getDayElecQuantityç­‰)
    // è¿™é‡Œæ˜¯ç¤ºæ„ï¼Œæ‚¨éœ€è¦å¡«å……å®Œæ•´çš„ä¸šåŠ¡é€»è¾‘
    log.info(`ä¸ºç”¨æˆ·ç´¢å¼• ${userIndex} è·å–æ•°æ®ï¼Œå‚æ•°: ${JSON.stringify(params)}`);
    // ç¤ºä¾‹ï¼šæ¨¡æ‹Ÿè¿”å›æ•°æ®
    return {
      eleBill: { sumMoney: "50.00" },
      dayElecQuantity: { today: "10" },
      monthElecQuantity: { thisMonth: "300" }
    };
  }

  // --- è„šæœ¬ä¸»å…¥å£ (é€‚é… Loon çš„ http-request è§¦å‘) ---
  try {
    // 1. æ£€æŸ¥è´¦å·å¯†ç 
    const USERNAME = store.get("95598_username") || "";
    const PASSWORD = store.get("95598_password") || "";
    if (!USERNAME || !PASSWORD) {
      throw new Error("è¯·å…ˆåœ¨ Loon çš„æŒä¹…åŒ–å­˜å‚¨ä¸­é…ç½® '95598_username' å’Œ '95598_password'ã€‚");
    }

    // 2. è·å–å¹¶è§£æè¯·æ±‚å‚æ•°
    const requestParams = getUrlParams($request.url);
    log.debug("è¯·æ±‚å‚æ•°:", requestParams);

    // 3. æ‰§è¡Œä¸šåŠ¡æµç¨‹
    await getKeyCode();
    if (!bizrt?.token || !bizrt?.userInfo) {
      await doLogin();
    }
    await getAuthcode();
    await getAccessToken();
    await getBindInfo();

    // 4. ä¸ºæ¯ä¸ªç»‘å®šçš„ç”¨æˆ·è·å–æ•°æ®
    const results = [];
    for (let i = 0; i < Global.bindInfo.powerUserList.length; i++) {
      try {
        const data = await getDataSource(i, requestParams); // è¿™é‡Œåº”ä¼ å…¥å…·ä½“å‚æ•°è°ƒç”¨çœŸå®å‡½æ•°
        results.push({
          userInfo: Global.bindInfo.powerUserList[i],
          ...data
        });
      } catch (err) {
        log.error(`å¤„ç†ç”¨æˆ· ${i} æ—¶å‡ºé”™:`, err);
        results.push({ error: err.message });
      }
    }

    // 5. æ„å»ºå¹¶è¿”å›æˆåŠŸå“åº”
    const response = {
      status: 200,
      headers: { 'Content-Type': 'application/json;charset=utf-8' },
      body: JSON.stringify(results)
    };
    $done(response);

  } catch (error) {
    log.error("è„šæœ¬æ‰§è¡Œå‡ºé”™:", error);
    // å¦‚æœæ˜¯è®¤è¯é”™è¯¯ï¼Œæ¸…é™¤ç¼“å­˜
    if (/æ— æ•ˆ|å¤±æ•ˆ|è¿‡æœŸ|é‡æ–°è·å–|Token|KeyCode/.test(error.message)) {
      store.clear("95598_bizrt");
      log.info("å·²æ¸…é™¤è®¤è¯ç¼“å­˜");
    }
    // è¿”å›é”™è¯¯å“åº”
    const errorResponse = {
      status: 500,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ error: error.message })
    };
    $done(errorResponse);
  }
})();

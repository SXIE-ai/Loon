/*
 * QQéŸ³ä¹æ’ä»¶å·¥å…·å‡½æ•°åº“
 */

const QQMusicUtils = {
    // è®¡ç®—g_tkå€¼
    calculateGTK: function(cookie) {
        const pskeyMatch = cookie.match(/p_skey=([^;]+)/i);
        if (!pskeyMatch) return 5381;
       Â 
        const pskey = pskeyMatch[1];
        let hash = 5381;
       Â 
        for (let i = 0; i < pskey.length; i++) {
            hash += (hash << 5) + pskey.charCodeAt(i);
        }
       Â 
        return hash & 0x7fffffff;
    },

    // æå–uin
    extractUin: function(cookie) {
        const match = cookie.match(/uin=o?(\d+)/i);
        return match ? match[1] : '0';
    },

    // æ„å»ºæŸ¥è¯¢å­—ç¬¦ä¸²
    buildQueryString: function(params) {
        return Object.keys(params)
            .map(key => `${encodeURIComponent(key)}=${encodeURIComponent(params[key])}`)
            .join('&');
    },

    // æ ¼å¼åŒ–æ—¶é—´
    formatTime: function(date) {
        return date.toLocaleTimeString('zh-CN', {
            hour: '2-digit',
            minute: '2-digit'
        });
    },

    // æ ¼å¼åŒ–æ—¥æœŸ
    formatDate: function(date) {
        return date.toLocaleDateString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
        });
    },

    // å»¶è¿Ÿå‡½æ•°
    delay: function(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    },

    // è§£æå¥–åŠ±ä¿¡æ¯
    parseReward: function(rewardData) {
        const rewards = [];
       Â 
        if (rewardData.exp) rewards.push(`ç»éªŒ+${rewardData.exp}`);
        if (rewardData.point) rewards.push(`ç§¯åˆ†+${rewardData.point}`);
        if (rewardData.vip_point) rewards.push(`æˆé•¿å€¼+${rewardData.vip_point}`);
        if (rewardData.coupon) rewards.push(`ä¼˜æƒ åˆ¸: ${rewardData.coupon}`);
        if (rewardData.other) rewards.push(rewardData.other);
       Â 
        return rewards.length > 0 ? rewards.join(', ') : 'æ— å¥–åŠ±';
    },

    // éªŒè¯å“åº”
    validateResponse: function(data) {
        try {
            const json = typeof data === 'string' ? JSON.parse(data) : data;
            return json && typeof json === 'object';
        } catch (e) {
            return false;
        }
    },

    // ç”Ÿæˆè¯·æ±‚ID
    generateRequestId: function() {
        return 'req_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    },

    // å­˜å‚¨ç®¡ç†
    Storage: {
        set: function(key, value, ttl = null) {
            const item = {
                value: value,
                expires: ttl ? Date.now() + ttl * 1000 : null
            };
            $persistentStore.write(JSON.stringify(item), key);
        },

        get: function(key) {
            const itemStr = $persistentStore.read(key);
            if (!itemStr) return null;
           Â 
            try {
                const item = JSON.parse(itemStr);
                if (item.expires && Date.now() > item.expires) {
                    $persistentStore.write('', key);
                    return null;
                }
                return item.value;
            } catch (e) {
                return null;
            }
        },

        remove: function(key) {
            $persistentStore.write('', key);
        }
    },

    // æ—¥å¿—ç®¡ç†
    Logger: {
        enabled: true,
       Â 
        log: function(message, level = 'info') {
            if (!this.enabled) return;
           Â 
            const timestamp = new Date().toISOString();
            const levels = {
                info: 'â„¹ï¸',
                warn: 'âš ï¸',
                error: 'âŒ',
                debug: 'ğŸ›',
                success: 'âœ…'
            };
           Â 
            const icon = levels[level] || levels.info;
            console.log(`[${timestamp}] ${icon} QQMusic: ${message}`);
        },
       Â 
        info: function(message) {
            this.log(message, 'info');
        },
       Â 
        warn: function(message) {
            this.log(message, 'warn');
        },
       Â 
        error: function(message) {
            this.log(message, 'error');
        },
       Â 
        success: function(message) {
            this.log(message, 'success');
        }
    }
};

// å¯¼å‡ºæ¨¡å—
if (typeof module !== 'undefined') {
    module.exports = QQMusicUtils;
}
